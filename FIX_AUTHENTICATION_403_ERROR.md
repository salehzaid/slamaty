# ุฅุตูุงุญ ุฎุทุฃ 403 - ุบูุฑ ูุตุงุฏู
## Fix 403 Forbidden - Not Authenticated Error

> ๐ ุชุงุฑูุฎ ุงูุฅุตูุงุญ: 7 ุฃูุชูุจุฑ 2025  
> ๐ ุงูุฎุทุฃ: `403 Forbidden - Not authenticated`

---

## ๐ ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุชุญุฏูุซ ุนูุงุตุฑ ุงูุชููููุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
Failed to load resource: the server responded with a status of 403 (Forbidden)
โ API request failed: Error: HTTP error! status: 403, message: {"detail":"Not authenticated"}
```

### ุงูุฃุนุฑุงุถ:
- โ ูุง ูููู ุชุญููู ุงูุจูุงูุงุช ูู API
- โ ูุง ูููู ุญูุธ ุงูุชุนุฏููุงุช
- โ ุฑุณุงุฆู ุฎุทุฃ `403 Forbidden` ูู console
- โ ุฑุณุงูุฉ `"Not authenticated"` ูู ุงูุฎุงุฏู

---

## ๐ ุงูุณุจุจ ุงูุฌุฐุฑู

### ุงูุณุจุจ ุงูุฑุฆูุณู: **ุงูุชูุงุก ุตูุงุญูุฉ token ุงูุชูุซูู**

ุงูู JWT token ูู ูุฏุฉ ุตูุงุญูุฉ ูุญุฏูุฏุฉ (30 ุฏูููุฉ ุงูุชุฑุงุถูุงู). ุจุนุฏ ุงูุชูุงุก ุงูุตูุงุญูุฉ:
- โ ุงูุฎุงุฏู ูุฑูุถ ุฌููุน ุงูุทูุจุงุช ุจู `403 Forbidden`
- โ ุงููุณุชุฎุฏู ูุจูู ูู ุงูุตูุญุฉ ุจุฏูู ุฅุนุงุฏุฉ ุชูุฌูู
- โ ูุง ุชูุฌุฏ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู

### ุงููุดููุฉ ูู ุงูููุฏ ุงูุณุงุจู:

```javascript
// โ ุงูููุฏ ุงููุฏูู: ูุชุนุงูู ููุท ูุน 401
if (response.status === 401) {
  // ...
}
```

**ูู ููู ููุงู ูุนุงูุฌุฉ ูุฎุทุฃ 403!**

---

## โ ุงูุญููู ุงููุทุจูุฉ

### 1๏ธโฃ ุงูุชุนุงูู ูุน ุฎุทุฃ 403 ูุซู 401

**ุงูููู:** `src/lib/api.ts`

```javascript
// โ ุงูููุฏ ุงูุฌุฏูุฏ: ูุชุนุงูู ูุน 401 ู 403
if (response.status === 401 || response.status === 403) {
  console.error('๐ Authentication Error:', response.status)
  localStorage.removeItem('access_token')
  localStorage.removeItem('sallamaty_user')
  
  // ุนุฑุถ ุฑุณุงูุฉ ูููุณุชุฎุฏู ูุจู ุฅุนุงุฏุฉ ุงูุชูุฌูู
  const message = response.status === 401 
    ? 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู.'
    : 'ุบูุฑ ูุตุฑุญ ุจุงููุตูู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู.'
  
  alert(message)
  window.location.href = '/login'
  throw new Error('Authentication required')
}
```

**ุงูููุงุฆุฏ:**
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
- โ ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ ูู localStorage
- โ ุฅุนุงุฏุฉ ุชูุฌูู ุชููุงุฆูุฉ ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู

### 2๏ธโฃ ุชุญุฏูุซ ุชููุงุฆู ููู token

**ุงูููู:** `src/hooks/useEvaluationApi.ts`

```javascript
const loadCategories = async () => {
  try {
    setLoading(true)
    setError(null)
    
    // โ ุชุญุฏูุซ ุงูู token ูุจู ุฅุฑุณุงู ุงูุทูุจ
    apiClient.refreshToken()
    
    console.log('Current token:', localStorage.getItem('access_token') ? 'Token exists' : 'No token')
    
    const response = await apiClient.getEvaluationCategories()
    // ...
  } catch (err: any) {
    // โ ุงูุชุญูู ูู ุฃุฎุทุงุก ุงูุชูุซูู
    if (err.message?.includes('Authentication required') || err.message?.includes('403')) {
      setError('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู')
    }
  }
}
```

**ุงูููุงุฆุฏ:**
- โ ูุฑุงุกุฉ ุงูู token ูู localStorage ูุจู ูู ุทูุจ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุชุณุฌูู ูู console ูุชุณููู ุงูุชุดุฎูุต

### 3๏ธโฃ ุชุณุฌูู ุฃูุถู ูู Console

```javascript
console.log('๐ API Request - URL:', url)
console.log('๐ API Request - Config:', config)
console.log('๐ฅ API Response - Status:', response.status)
console.log('Current token:', localStorage.getItem('access_token') ? 'Token exists' : 'No token')
```

---

## ๐ง ุงูุญู ุงูุณุฑูุน ูููุณุชุฎุฏู

### ุฅุฐุง ูุงุฌูุช ุฎุทุฃ 403:

#### ุงูุทุฑููุฉ 1: ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู (ุงูุฃุณุฑุน)
1. **ุงุถุบุท F5** ูุชุญุฏูุซ ุงูุตูุญุฉ
2. ุณูุชู **ุฅุนุงุฏุฉ ุชูุฌููู** ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ุชููุงุฆูุงู
3. **ุณุฌู ุฏุฎููู** ุจููุณ ุงูุจูุงูุงุช

#### ุงูุทุฑููุฉ 2: ูุณุญ ุงูุจูุงูุงุช ูุฏููุงู
1. **ุงูุชุญ Console** (F12)
2. **ุงูุชุจ:**
   ```javascript
   localStorage.clear()
   location.reload()
   ```
3. **ุณุฌู ุฏุฎููู** ูุฑุฉ ุฃุฎุฑู

#### ุงูุทุฑููุฉ 3: ุงุณุชุฎุฏุงู Incognito Mode
1. **ุงูุชุญ ูุงูุฐุฉ ุฎุงุตุฉ** (Incognito)
2. **ุณุฌู ุฏุฎููู** ูู ุฌุฏูุฏ
3. ูุฐุง ุณูุถูู ุนุฏู ูุฌูุฏ ุจูุงูุงุช ูุฏููุฉ

---

## ๐งช ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุงูุชูุซูู ุงูุฃุณุงุณู

```javascript
// ูู Console (F12)
console.log('Token:', localStorage.getItem('access_token'))
console.log('User:', localStorage.getItem('sallamaty_user'))
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุฌุจ ุฃู ูุธูุฑ token ุทููู
- โ ูุฌุจ ุฃู ุชุธูุฑ ุจูุงูุงุช ุงููุณุชุฎุฏู

### 2. ุงุฎุชุจุงุฑ ุตูุงุญูุฉ Token

```javascript
// ูู Console
const token = localStorage.getItem('access_token')
if (token) {
  const payload = JSON.parse(atob(token.split('.')[1]))
  const expDate = new Date(payload.exp * 1000)
  console.log('Token expires:', expDate)
  console.log('Is expired:', expDate < new Date())
} else {
  console.log('No token found')
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุธูุฑ ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ
- โ ููุถุญ ุฅุฐุง ูุงู ููุชูู ุงูุตูุงุญูุฉ ุฃู ูุง

### 3. ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงูุจูุงูุงุช

1. **ุณุฌู ุงูุฏุฎูู**
2. **ุงุฐูุจ ุฅูู** ุนูุงุตุฑ ุงูุชูููู
3. **ุนุฏูู** ุนูุตุฑูุง
4. **ุงุญูุธ** ุงูุชุนุฏููุงุช
5. **ุชุญูู** ูู ุญูุธ ุงูุชุนุฏููุงุช

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุชูุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ
- โ ุฑุณุงูุฉ "ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ"
- โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก 403 ูู console

---

## ๐ ููุงุฑูุฉ: ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ

### ูุจู ุงูุฅุตูุงุญ:

```
โ ุฎุทุฃ 403 โ ูุง ุดูุก ูุญุฏุซ
โ ุงููุณุชุฎุฏู ูุจูู ูู ุงูุตูุญุฉ
โ ูุง ุชูุฌุฏ ุฑุณุงูุฉ ุชูุถูุญูุฉ
โ ุงูุจูุงูุงุช ุงููุฏููุฉ ุชุจูู ูู localStorage
โ ูุง ูููู ุชุญููู ุฃู ุญูุธ ุงูุจูุงูุงุช
```

### ุจุนุฏ ุงูุฅุตูุงุญ:

```
โ ุฎุทุฃ 403 โ ุฑุณุงูุฉ ูุงุถุญุฉ
โ ุฅุนุงุฏุฉ ุชูุฌูู ุชููุงุฆูุฉ ูุชุณุฌูู ุงูุฏุฎูู
โ ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ
โ ุชุญุฏูุซ ุชููุงุฆู ููู token
โ ุชุณุฌูู ููุตู ูู console
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ุงููุชูุฏู

### ุงููุดููุฉ 1: ุงูุฎุทุฃ ูุณุชูุฑ ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู

**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:**
1. ุงูุฎุงุฏู (Backend) ูุง ูุนูู
2. ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ุฎุงุทุฆุฉ
3. ูุดููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู:**
```bash
# ุชุญูู ูู ุชุดุบูู ุงูุฎุงุฏู
cd backend
python -m uvicorn main:app --reload --port 8000

# ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
psql -d salamaty_db -c "SELECT * FROM users LIMIT 1;"
```

### ุงููุดููุฉ 2: Token ููุชูู ุจุณุฑุนุฉ

**ุงูุณุจุจ:** `ACCESS_TOKEN_EXPIRE_MINUTES` ูุตูุฑุฉ ุฌุฏุงู

**ุงูุญู:** ูู `backend/auth.py`:
```python
# ูุจู
ACCESS_TOKEN_EXPIRE_MINUTES = 30  # 30 ุฏูููุฉ ููุท

# ุจุนุฏ (ููุชุทููุฑ)
ACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24 ุณุงุนุฉ
```

### ุงููุดููุฉ 3: CORS errors

**ุงูุฃุนุฑุงุถ:**
```
Access to fetch at 'http://localhost:8000/api/...' from origin 'http://localhost:5173' 
has been blocked by CORS policy
```

**ุงูุญู:** ูู `backend/main.py`:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173", "http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## ๐ ูุนูููุงุช ุฅุถุงููุฉ ุนู JWT Tokens

### ูุง ูู JWT Tokenุ

JWT (JSON Web Token) ูู:
- ๐ **ุทุฑููุฉ ุขููุฉ** ูููู ุงููุนูููุงุช
- โฐ **ูู ุตูุงุญูุฉ ูุญุฏูุฏุฉ** (exp)
- ๐ฏ **ูุญุชูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู** (sub, role, etc)

### ุจููุฉ JWT Token:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiZXhwIjoxNzU5NjQ3OTgwfQ.signature
โ                                        โ                                                    โ
โโโโโโโโโโโโ Header โโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ Payload โโโโโโโโโโโโโโโโโโโโโโโโโโโดโโ Signature
```

### ูุญุต Token ูู console:

```javascript
const token = localStorage.getItem('access_token')
const parts = token.split('.')
console.log('Header:', JSON.parse(atob(parts[0])))
console.log('Payload:', JSON.parse(atob(parts[1])))
```

---

## ๐ฏ ุฃูุถู ุงูููุงุฑุณุงุช

### ูููุทูุฑูู:

1. โ **ุชุญุฏูุซ Token ุชููุงุฆูุงู** ูุจู ูู ุทูุจ API
2. โ **ุงูุชุนุงูู ูุน ุฌููุน ุฃุฎุทุงุก ุงูุชูุซูู** (401, 403)
3. โ **ุฑุณุงุฆู ูุงุถุญุฉ** ูููุณุชุฎุฏู
4. โ **ุชุณุฌูู ููุตู** ูู console
5. โ **ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ** ุนูุฏ Logout

### ูููุณุชุฎุฏููู:

1. โ **ุณุฌู ุงูุฏุฎูู** ุนูุฏ ุจุฏุก ุงูุนูู
2. โ **ุญุฏูุซ ุงูุตูุญุฉ** ุฅุฐุง ูุงุฌูุช ูุดุงูู
3. โ **ูุง ุชุชุฑู ุงูุตูุญุฉ ููุชูุญุฉ** ููุชุฑุงุช ุทูููุฉ
4. โ **ุณุฌู ุงูุฎุฑูุฌ** ุนูุฏ ุงูุงูุชูุงุก

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู

ูุจู ุงูุจุฏุก ุจุงูุนูู:

- [ ] ุงูุฎุงุฏู (Backend) ูุนูู ุนูู port 8000
- [ ] Frontend ูุนูู ุนูู port 5173 ุฃู 3000
- [ ] ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุตูุฉ
- [ ] ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ
- [ ] Token ููุฌูุฏ ูู localStorage
- [ ] Token ูู ููุชูู ุตูุงุญูุชู

ุนูุฏ ููุงุฌูุฉ ูุดููุฉ:

- [ ] ุชุญูู ูู console ููุฃุฎุทุงุก
- [ ] ุชุญูู ูู Network tab
- [ ] ุชุญูู ูู ุตูุงุญูุฉ Token
- [ ] ุฌุฑุจ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ
- [ ] ุฌุฑุจ ูุณุญ localStorage
- [ ] ุฌุฑุจ Incognito mode

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

| ุงูููู | ุงูุชุบููุฑ | ุงูุณุทูุฑ |
|-------|---------|--------|
| `src/lib/api.ts` | ุฅุถุงูุฉ ูุนุงูุฌุฉ ูุฎุทุฃ 403 | 82-96 |
| `src/hooks/useEvaluationApi.ts` | ุชุญุฏูุซ token ุชููุงุฆูุงู | 132-202 |

---

## โ ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ูุดููุฉ 403 Forbidden ุจูุฌุงุญ ูู ุฎูุงู:

1. โ **ูุนุงูุฌุฉ ุฎุทุฃ 403** ูุน ุฑุณุงูุฉ ูุงุถุญุฉ
2. โ **ุฅุนุงุฏุฉ ุชูุฌูู ุชููุงุฆูุฉ** ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
3. โ **ุชุญุฏูุซ ุชููุงุฆู ููู token** ูุจู ูู ุทูุจ
4. โ **ุชุณุฌูู ููุตู** ูุชุณููู ุงูุชุดุฎูุต
5. โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ** ูููุณุชุฎุฏู

**ุงูุขู ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู ูุจู ุชุนุฏูู ุงูุจูุงูุงุช!** ๐

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุณุฌู ุงูุฏุฎูู** ุจุงูุจูุงูุงุช ุงูุตุญูุญุฉ
2. **ุนุฏูู ุนูุงุตุฑ ุงูุชูููู** ูุณุชูุญูุธ ุจูุฌุงุญ
3. **ุฅุฐุง ูุงุฌูุช ูุดุงูู**ุ ุฑุงุฌุน ุฏููู ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ุฃุนูุงู

---

**๐ ุชู ุงูุฅุตูุงุญ ูุงูุชูุซูู ุจูุฌุงุญ! ๐**

