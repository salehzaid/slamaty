#!/usr/bin/env python3
"""
Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
"""

import os
import sys
from database import get_db
from models_updated import User, UserRole
from auth import get_password_hash
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()

def create_test_user():
    """Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¬Ø¯ÙŠØ¯"""
    
    try:
        db = next(get_db())
        
        print("ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¬Ø¯ÙŠØ¯...")
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        username = "testuser"
        email = "testuser@salamaty.com"
        password = "test123"
        
        # ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
        existing_user = db.query(User).filter(User.username == username).first()
        if existing_user:
            print(f"âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {username} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
            # ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            existing_user.hashed_password = get_password_hash(password)
            db.commit()
            print(f"ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
        else:
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            hashed_password = get_password_hash(password)
            
            new_user = User(
                username=username,
                email=email,
                first_name="Ù…Ø³ØªØ®Ø¯Ù…",
                last_name="ØªØ¬Ø±ÙŠØ¨ÙŠ",
                role=UserRole.SUPER_ADMIN,
                department="ØªØ¬Ø±ÙŠØ¨ÙŠ",
                phone="0501234999",
                position="Ù…Ø®ØªØ¨Ø±",
                hashed_password=hashed_password,
                is_active=True
            )
            
            db.add(new_user)
            db.commit()
            print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯")
        
        print("\nğŸ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø§Ù‡Ø²!")
        print(f"\nğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:")
        print(f"   ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {username}")
        print(f"   ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {password}")
        print(f"   ğŸ“§ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: {email}")
        print(f"   ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {password}")
        
        # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†
        print(f"\nğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†:")
        users = db.query(User).filter(User.is_active == True).all()
        for user in users:
            print(f"  ğŸ‘¤ {user.username} ({user.email}) - {user.first_name} {user.last_name}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return False

if __name__ == "__main__":
    print("ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ")
    print("=" * 30)
    
    if create_test_user():
        print("\nâœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!")
        print("\nØ§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ:")
        print("1. ÙØªØ­ http://localhost:5174")
        print("2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€: testuser / test123")
    else:
        print("\nâŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        sys.exit(1)
