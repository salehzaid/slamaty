# ØªØ­Ø³ÙŠÙ† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®Ø·Ø· Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© (CAPA) â€” Ø®Ø·ÙˆØ§Øª ÙˆØ£ÙˆØ§Ù…Ø± Ø¬Ø§Ù‡Ø²Ø© Ù„Ù€ Cursor AI

> ÙˆØ«ÙŠÙ‚Ø© Ø¹Ù…Ù„ÙŠØ© Ø®Ø·ÙˆØ©â€‘Ø¨Ø®Ø·ÙˆØ© Ù„Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° ÙˆØªØ­Ø³ÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø·Ø· Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ **Ù†Ø¸Ø§Ù… Ø³Ù„Ø§Ù…ØªÙŠ**. ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙˆØ§Ù…Ø± (prompts) Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØµÙ‚ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Cursor AIØŒ ØªØºÙŠÙŠØ±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§ØªØŒ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ ÙˆØ£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª.

---

## ğŸ¯ Ø§Ù„Ù‡Ø¯Ù

ØªØ­Ø³ÙŠÙ† Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø®Ø·Ø· Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© (CAPA) Ù„ØªÙƒÙˆÙ† Ø¢Ù„ÙŠØ©ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØªØ¨Ø¹ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ØŒ ÙˆØªØ¯Ø¹Ù… Ø£Ø¯ÙˆØ§Ø± Ù…ØªØ¹Ø¯Ø¯Ø© (Ø¥Ù†Ø´Ø§Ø¡ØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŒ ØªÙ†ÙÙŠØ°ØŒ ØªØ­Ù‚Ù‚ØŒ Ø¥ØºÙ„Ø§Ù‚ØŒ ØªØµØ¹ÙŠØ¯).

---

## ğŸ“Œ ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
1. Ø§ÙØªØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Cursor AI.  
2. Ø£Ù†Ø´Ø¦ ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯: `git checkout -b feat/capa-improvements`  
3. Ø§Ù†Ø³Ø® ÙƒÙ„ prompt (Ø§Ù„Ø£Ù…Ø±) ÙÙŠ Ø§Ù„Ù‚Ø³Ù… "Ø£ÙˆØ§Ù…Ø± Cursor AI Ø¬Ø§Ù‡Ø²Ø©" Ø¥Ù„Ù‰ Ø¯Ø±Ø¯Ø´Ø© Cursor AI Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„.

---

## Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø©)
1. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ø¯ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ CAPA + Ù…Ù‡Ø§Ø¬Ø±ØªÙŠÙ† Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª).  
2. ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù€ API (CRUD + Verify + Audit).  
3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ CAPA + Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø©).  
4. Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù„ÙŠØ© (Ø¥Ù†Ø´Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ØªØ°ÙƒÙŠØ±ØŒ ØªØµØ¹ÙŠØ¯).  
5. Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (ÙˆØ­Ø¯Ø§ØªØŒ ØªÙƒØ§Ù…Ù„ØŒ ÙˆØ§Ø¬Ù‡Ø©).  
6. CI/CD ÙˆÙ†Ø´Ø±.

---

## âœ³ï¸ Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‚ØªØ±Ø­ â€” ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ **capas**

**Ø¥Ø¶Ø§ÙØ§Øª Ù„Ù„Ø­Ù‚Ù„ (capas table)**
- `root_cause: TEXT`  
- `corrective_actions: JSONB` â€” Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø¹ ØªÙˆØ§Ø±ÙŠØ® ÙˆÙ…Ø±Ø¤ÙˆØ³ÙŠÙ† ÙˆØ­Ø§Ù„Ø© ÙƒÙ„ Ø¥Ø¬Ø±Ø§Ø¡.  
- `preventive_actions: JSONB`  
- `verification_steps: JSONB` â€” Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø®Ø·Ø©.  
- `verification_status: ENUM('pending','in_review','verified','rejected')`  
- `severity: SMALLINT` â€” 1 (Ù…Ù†Ø®ÙØ¶) .. 5 (Ø­Ø±Ø¬)  
- `estimated_cost: NUMERIC`  
- `status_history: JSONB` â€” Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (timestamp, user_id, from, to, note).  
- `sla_days: INT` â€” Ù…Ù‡Ù„Ø© Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.  
- `escalation_level: INT` â€” Ø¹Ø¯Ø¯ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªØµØ¹ÙŠØ¯ Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©.  
- `closed_at: TIMESTAMP NULLABLE`  
- `verified_at: TIMESTAMP NULLABLE`  

**Ù…Ø¤Ø´Ø±Ø§Øª ÙˆÙÙ‡Ø§Ø±Ø³**
- ÙÙ‡Ø±Ø³ Ø¹Ù„Ù‰: `(department, status, severity)`  
- ÙÙ‡Ø±Ø³ GIN Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ JSONB (e.g. `corrective_actions`) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù….

---

## âœ… Ù…Ù„Ù Ù…Ù‡Ø§Ø¬Ø±Ø© Alembic â€” Ù…Ø«Ø§Ù„ (SQL)
```sql
-- alembic revision: add_capa_fields
ALTER TABLE capas
  ADD COLUMN root_cause TEXT,
  ADD COLUMN corrective_actions JSONB DEFAULT '[]',
  ADD COLUMN preventive_actions JSONB DEFAULT '[]',
  ADD COLUMN verification_steps JSONB DEFAULT '[]',
  ADD COLUMN verification_status VARCHAR(20) DEFAULT 'pending',
  ADD COLUMN severity SMALLINT DEFAULT 3,
  ADD COLUMN estimated_cost NUMERIC,
  ADD COLUMN status_history JSONB DEFAULT '[]',
  ADD COLUMN sla_days INT DEFAULT 14,
  ADD COLUMN escalation_level INT DEFAULT 0,
  ADD COLUMN closed_at TIMESTAMP NULL,
  ADD COLUMN verified_at TIMESTAMP NULL;

CREATE INDEX ix_capa_department_status_severity ON capas(department, verification_status, severity);
CREATE INDEX ix_capa_corrective_actions_gin ON capas USING gin(corrective_actions);
```

---

## ğŸ§  Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© (Business rules)
- **Ø¥Ù†Ø´Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ**: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ØªÙŠØ¬Ø© Ø¹Ù†ØµØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… `non_compliant` Ùˆ `risk_level >= 3` ÙÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ CAPA ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø¹ Ù…Ù„Ø¡ `target_date = now() + sla_days` Ùˆ `severity` Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ `risk_level`.
- **Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ±Ø©**: `draft -> assigned -> in_progress -> pending_verification -> verified/closed`.
- **Ø§Ù„ØªØ­Ù‚Ù‚**: Ù„Ø§ ØªÙÙ‚ÙÙ„ Ø§Ù„Ø®Ø·Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… ÙƒÙ„ `verification_steps` ÙˆØ§Ù„Ù€ verifier ÙŠÙ‚ÙˆÙ… Ø¨ØªØ£ÙƒÙŠØ¯ ÙƒÙ„ Ø®Ø·ÙˆØ©.
- **Ø§Ù„ØªØµØ¹ÙŠØ¯**: Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø®Ø·Ø© `target_date` Ø£Ùˆ `sla_days` Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ«ØŒ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø¢Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±.
- **ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª**: ÙƒÙ„ ØªØºÙŠÙŠØ± ÙÙŠ CAPA ÙŠÙØ³Ø¬Ù„ ÙÙŠ `status_history` ÙˆÙŠÙØ¯Ø®Ù„ ÙÙŠ `audit_logs`.

---

## ğŸ”Œ ÙˆØ§Ø¬Ù‡Ø§Øª API Ù…Ù‚ØªØ±Ø­Ø© (FastAPI)

### Endpoints
- `POST /api/capas` â€” Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©.  
- `GET /api/capas/{id}` â€” Ø¬Ù„Ø¨ Ø®Ø·Ø© ÙˆØ§Ø­Ø¯.  
- `PATCH /api/capas/{id}` â€” ØªØ¹Ø¯ÙŠÙ„ (Ø­Ø§Ù„Ø©ØŒ Ø¥Ø¬Ø±Ø§Ø¡Ø§ØªØŒ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ù‚Ù‚).  
- `POST /api/capas/{id}/verify` â€” Ø¹Ù…Ù„ÙŠØ© ØªØ­Ù‚Ù‚ (Ù…Ø¹ body ÙŠØ´Ø±Ø­ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©).  
- `GET /api/capas?department=&status=&severity=` â€” ÙÙ„ØªØ±Ø©.

### Ù…Ø«Ø§Ù„ Ø¬Ø³Ù… Ø§Ù„Ø·Ù„Ø¨ â€” Ø¥Ù†Ø´Ø§Ø¡
```json
{
  "title": "ØªØ³Ø±Ø¨ Ø¯ÙˆØ§Ø¡ ÙÙŠ Ù…Ø®Ø²Ù† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©",
  "description": "ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©...",
  "round_id": 123,
  "department": "Pharmacy",
  "assigned_to_id": 45,
  "severity": 4,
  "estimated_cost": 1200.00,
  "corrective_actions": [{"task":"ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†","due_date":"2025-10-01","assigned_to_id":45}],
  "verification_steps": [{"step":"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©","required":true},{"step":"ØªØ£ÙƒÙŠØ¯ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸Ù","required":false}]
}
```

---

## ğŸ§© Ù…Ø«Ø§Ù„ ÙƒÙˆØ¯ FastAPI (Router Ù…Ø®ØªØµØ±)
```python
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime

router = APIRouter(prefix="/api/capas")

class Action(BaseModel):
    task: str
    due_date: Optional[datetime]
    assigned_to_id: Optional[int]
    status: Optional[str] = "open"

class CAPACreate(BaseModel):
    title: str
    description: Optional[str]
    round_id: Optional[int]
    department: str
    assigned_to_id: Optional[int]
    severity: int = Field(ge=1, le=5)
    estimated_cost: Optional[float]
    corrective_actions: List[Action] = []
    verification_steps: List[dict] = []

@router.post("/")
async def create_capa(payload: CAPACreate, user=Depends(get_current_user)):
    # ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    # Ø£Ù†Ø´Ø¦ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ DB
    # Ø£Ø¶Ù Ø³Ø¬Ù„ ÙÙŠ audit_logs
    # Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ÙƒÙ„Ù
    return {"status":"ok","capa_id": 123}
```

---

## ğŸ–¥ï¸ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (React) â€” Ù†Ù…ÙˆØ°Ø¬ CAPA Ù…Ø¹ React Hook Form + Zod (Ù…Ø®ØªØµØ±)

```tsx
import { useForm, Controller } from 'react-hook-form'
import { z } from 'zod'
import { zodResolver } from '@hookform/resolvers/zod'

const schema = z.object({
  title: z.string().min(5),
  department: z.string().min(1),
  severity: z.number().min(1).max(5),
  corrective_actions: z.array(z.object({ task: z.string().min(3), due_date: z.string().optional() }))
})

export default function CapaForm({ defaultValues, onSubmit }){
  const { control, handleSubmit, register } = useForm({ resolver: zodResolver(schema), defaultValues })
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('title')} placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø·Ø©" />
      <input {...register('department')} placeholder="Ø§Ù„Ù‚Ø³Ù…" />
      <input type="number" {...register('severity')} placeholder="Ø´ÙØ¯Ù‘Ø©" />
      {/* Ù…ÙƒÙˆÙ† Ù„Ø¥Ø¯Ø§Ø±Ø© corrective_actions */}
      <button type="submit">Ø­ÙØ¸</button>
    </form>
  )
}
```

---

## âš™ï¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø£ØªÙ…ØªØ© (Automation) â€” Ø£Ù…Ø«Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©
1. **Ø¥Ù†Ø´Ø§Ø¡ CAPA ØªÙ„Ù‚Ø§Ø¦ÙŠ** (Server-side hook Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© ØªÙ‚ÙŠÙŠÙ…):
   - Ø´Ø±Ø·: `result == 'non_compliant' AND risk_level >= 3`  
   - Ø¥Ø¬Ø±Ø§Ø¡: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `POST /api/capas` Ù…Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.

2. **ØªØ°ÙƒÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ**: Ù…Ù‡Ù…Ø© Ù…Ø¬Ø¯ÙˆÙ„Ø© ØªØ¹Ù…Ù„ ÙŠÙˆÙ…ÙŠÙ‹Ø§ ØªÙØ­Øµ `capas` Ø­ÙŠØ« `verification_status != 'verified' AND now() > target_date - 2` Ø«Ù… ØªØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ù‹Ø§.

3. **ØªØµØ¹ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ**: Ø¥Ø°Ø§ `now() > target_date + escalation_threshold` Ù‚Ù… Ø¨Ø²ÙŠØ§Ø¯Ø© `escalation_level` ÙˆØ£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¯ÙŠØ±.

---

## âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©
- **Backend**: pytest Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: Ø¥Ù†Ø´Ø§Ø¡ CAPAØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§ØªØŒ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ØŒ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØµØ¹ÙŠØ¯.
- **Frontend**: Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ­Ø¯Ø© Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (React Testing Library).  
- **E2E**: Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙƒØ§Ù…Ù„ (Ø¥Ù†Ø´Ø§Ø¡ â†’ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª â†’ ØªØ­Ù‚Ù‚ â†’ ØºÙ„Ù‚).

---

## ğŸ“‹ Ø£ÙˆØ§Ù…Ø± Cursor AI Ø¬Ø§Ù‡Ø²Ø© â€” Ø§Ù„ØµÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Cursor AI

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© A â€” Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„ÙØ±Ø¹
1. **Ø§ÙØªØ­ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯** (Ù‚Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§):
```
git checkout -b feat/capa-improvements
```
2. **Prompt in Cursor AI:**
```
Project: Salamaty. I want to improve the CAPA (corrective action plan) data model and lifecycle. Suggest a minimal DB schema diff (Postgres SQL) to add root_cause, corrective_actions (JSONB), verification_steps, verification_status, severity, sla_days, status_history and indexes. Provide the Alembic migration SQL only.
```
(Ù†ØªÙŠØ¬Ø© Ù…ØªÙˆÙ‚Ø¹Ø©: Ù…Ù„Ù Ù…Ù‡Ø§Ø¬Ø±Ø© SQL ÙƒÙ…Ø§ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ø¬Ø±Ø© Ø£Ø¹Ù„Ø§Ù‡)


### Ø§Ù„Ù…Ø±Ø­Ù„Ø© B â€” Backend endpoints & logic
3. **Prompt in Cursor AI:**
```
Based on the new DB fields, generate a FastAPI router with endpoints: POST /api/capas, GET /api/capas/{id}, PATCH /api/capas/{id}, POST /api/capas/{id}/verify. Include Pydantic models, permission checks (quality_manager or super_admin can create), audit log insertion, and events for notifications. Return code only.
```

4. **Prompt in Cursor AI (business rules):**
```
Write Python functions for: auto_create_capa_on_noncompliant(result_record), check_and_escalate_overdue_capas(), and update_status_history(capa_id, user_id, from_status, to_status, note). Use SQLAlchemy session examples. Return code only.
```


### Ø§Ù„Ù…Ø±Ø­Ù„Ø© C â€” Frontend forms & UI
5. **Prompt in Cursor AI:**
```
Create a React TypeScript component (default export) named CapaForm using React Hook Form and Zod. It should support adding/removing corrective actions, validation, and submitting to POST /api/capas. Use Tailwind classes and follow RTL. Return full component file code.
```

6. **Prompt in Cursor AI:**
```
Create a dashboard React component that lists CAPAs with filters (status, severity, department) and shows progress bar per CAPA (based on completed corrective_actions). Use Recharts to display severity distribution chart. Return code only.
```


### Ø§Ù„Ù…Ø±Ø­Ù„Ø© D â€” Automations & Cron jobs
7. **Prompt in Cursor AI:**
```
Provide a Python script (or FastAPI background task) named kapa_scheduler.py that: 1) runs daily, 2) finds overdue CAPAs, 3) increments escalation_level, 4) sends email notifications via a send_email(user_email, subject, body) function, and 5) updates audit_logs. Use SQLAlchemy pseudo code. Return code only.
```


### Ø§Ù„Ù…Ø±Ø­Ù„Ø© E â€” Tests & CI
8. **Prompt in Cursor AI:**
```
Generate pytest unit tests for the CAPA router: test_create_capa, test_update_capa_actions, test_verify_capa. Use TestClient from fastapi.testclient and a sqlite in-memory DB fixture. Return test files.
```

9. **Prompt in Cursor AI:**
```
Write a GitHub Actions workflow file .github/workflows/ci.yml that runs: lint (flake8), tests (pytest), and builds frontend (npm ci && npm run build). Use matrix for python versions [3.8,3.10]. Return YAML file.
```


### Ø§Ù„Ù…Ø±Ø­Ù„Ø© F â€” Documentation & release
10. **Prompt in Cursor AI:**
```
Create a Markdown release note titled 'CAPA improvements v1.1' summarizing DB changes, API changes, UI changes, automation, and migration instructions for operators. Include migration command examples. Return markdown.
```

---

## ğŸ§¾ Ù…Ù‚ØªØ±Ø­Ø§Øª Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±ÙˆØ¹
- ÙØ±Ø¹ Ø§Ù„Ø¹Ù…Ù„: `feat/capa-improvements`  
- Commit messages:
  - `feat(capa): add verification_steps and corrective_actions to capas table`
  - `feat(api): add CAPA CRUD and verify endpoints`
  - `feat(ui): add CapaForm and CapaDashboard components`
  - `test(ci): add unit and e2e tests for CAPA flow`

---

## ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ†ÙÙŠØ°ÙŠØ© Ø³Ø±ÙŠØ¹Ø©
- Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ù‡Ø§Ø¬Ø±Ø© ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ù‹Ø§ØŒ Ø«Ù… Ø§Ù„Ù€ API Ø«Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©â€”Ù‡Ø°Ø§ ÙŠÙ‚Ù„Ù„ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª.  
- Ø£Ø¶Ù Feature Flag Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ automation Ø§Ù„Ø¢Ù„ÙŠ ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§.  
- ÙˆØ«Ù‚ ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ (Pydantic) ÙˆÙˆØ§Ø¬Ù‡Ø§Øª API ÙÙŠ Swagger.  
- Ø¶Ø¹ Ø·Ø±Ù‚ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (backfill) Ù„Ø£ÙŠ CAPAs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.

---

## ğŸš€ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ù…Ø¨Ø§Ø´Ø±)
Ù†Ø³Ø® Ø§Ù„Ù€ prompts Ù…Ù† Ù‚Ø³Ù… **Ø£ÙˆØ§Ù…Ø± Cursor AI Ø¬Ø§Ù‡Ø²Ø©** ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Cursor AI Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© A. Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø© ÙŠØ¬Ù„Ø¨Ù‡Ø§ Cursor AI: Ø±Ø§Ø¬Ø¹ Ø±Ù…Ø² Ø§Ù„Ù…Ù‡Ø§Ø¬Ø±Ø© Ø«Ù… Ù†ÙÙ‘Ø°Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ÙˆØ´ØºÙ‘Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©.

---

Ø¥Ø°Ø§ Ø±ØºØ¨ØªØŒ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø¢Ù†:
- ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Alembic migration Ù…ÙØµÙ‘Ù„ (Python) Ø¬Ø§Ù‡Ø² Ù„Ù„ØµÙ‚ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ.  
- Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙƒÙˆÙ‘Ù† React CapaForm ÙƒØ§Ù…Ù„ (Ù…Ù„Ù ÙˆØ§Ø­Ø¯).  

Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø°ÙƒØ± Ø±Ù‚Ù…Ù‡Ø§: 1) ØªÙˆÙ„ÙŠØ¯ Ù…Ù‡Ø§Ø¬Ø±Ø© Alembic ÙƒØ§Ù…Ù„Ø©ØŒ 2) ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù React CapaForm ÙƒØ§Ù…Ù„ØŒ 3) ÙƒÙ„Ø§Ù‡Ù…Ø§ Ø§Ù„Ø¢Ù†.

